# Sync miner docs from https://github.com/tellor-io/telliot/tree/master/docs in miner-documentation folder in the current repo
name: Sync miner docs

on:
#  schedule: 
#  - cron: "0 0 * * *" # every 15 minutes. set to whatever interval you like
  pull_request:
  push:
    branches: [master]


jobs:
  miner-docs-synce:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # otherwise, you will failed to push refs to dest repo
      - uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: '5.32'

      # Runs a set of commands using the runners shell
      - name:  Sync
        run: |
          git clone https://github.com/hhio618/telliot -b master
          export TELLIOT_MD5=$(find ./telliot/docs  -type f -exec md5sum {} \; | md5sum | cut -d" " -f1)
          export CURRENT_MD5=$(find $GITHUB_WORKSPACE/miner-documentation -type f -exec md5sum {} \; | md5sum | cut -d" " -f1)
          if [ "$TELLIOT_MD5" != "$CURRENT_MD5" ];
          then 
             sed -i 's/(/(miner-documentation\//g' ./telliot/docs/INDEX.md
             export newContent=`cat ./telliot/docs/INDEX.md`
             # We don't need this information here
             rm -f ./telliot/docs/INDEX.md
             # Let's update the content table
             # perl -0777 -i -pe "s/(## Miner Documentation\\n).*?(\\n##)/\$1\n$newContent\n\$2/s" SUMMARY.md
          fi
          rm -rf ./telliot
      - name: Echo git diff
        run: |
          echo `git diff`
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
